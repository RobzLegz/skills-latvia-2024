"use strict";(()=>{var e={};e.id=551,e.ids=[551],e.modules={9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},8346:(e,t,r)=>{r.r(t),r.d(t,{config:()=>d,default:()=>l,routeModule:()=>c});var s={};r.r(s),r.d(s,{default:()=>u});var a=r(1802),n=r(7153),i=r(6249),o=r(9255);function u(e,t){"POST"===e.method&&o.R.logout(e,t)}let l=(0,i.l)(s,"default"),d=(0,i.l)(s,"config"),c=new a.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/user/logout",pathname:"/api/user/logout",bundlePath:"",filename:""},userland:s})},9255:(e,t,r)=>{r.d(t,{R:()=>c});var s=r(8438);let a=require("bcrypt");var n=r.n(a);let i=require("cookie");var o=r(9344),u=r.n(o);let l=e=>u().sign(e,String(process.env.REFRESH_TOKEN_SECRET));var d=r(9983);let c={register:async(e,t)=>{try{let{username:r,password:a}=e.body;if(!r||!a)return t.status(400).json({err:"Aizpildiet visus datus"});if(r.lengh<3)return t.status(400).json({err:"Lietotājvārdam jabut vismas 3 rakstzīmes garam"});if(a.lengh<3)return t.status(400).json({err:"Parolei jabut vismas 3 rakstzīmes garam"});if(await s._.user.findFirst({where:{username:r}}))return t.status(400).json({err:"Lietotājvārds jau aizņemts"});let o=await n().hash(a,10),u=await s._.user.create({data:{username:r,password:o}}),d=l(u.id),c=(0,i.serialize)("refresh_token",d,{httpOnly:!0,secure:!0,maxAge:604800,path:"/"});return t.setHeader("Set-Cookie",c),t.json(u)}catch(e){return console.log(e.message),t.status(500).json({err:"Radās kļūme"})}},login:async(e,t)=>{try{let{username:r,password:a}=e.body;if(!r||!a)return t.status(400).json({err:"Aizpildiet visus datus"});if(r.lengh<3)return t.status(400).json({err:"Lietotājvārdam jabut vismas 3 rakstzīmes garam"});if(a.lengh<3)return t.status(400).json({err:"Parolei jabut vismas 3 rakstzīmes garam"});let o=await s._.user.findFirst({where:{username:r}});if(!o)return t.status(404).json({err:"Lietotājs ar šādu lietotājvārdu netika atrasts"});n().compare(a,o.password,function(e,r){if(!r)return t.status(400).json({err:"Nepareiza parole"});{let e=l(o.id),r=(0,i.serialize)("refresh_token",e,{httpOnly:!0,secure:!0,maxAge:604800,path:"/"});return t.setHeader("Set-Cookie",r),t.json(o)}})}catch(e){return console.log(e.message),t.status(500).json({err:"Radās kļūme"})}},logout:async(e,t)=>{try{let e=(0,i.serialize)("refresh_token","",{httpOnly:!0,secure:!0,maxAge:604800,path:"/"});t.setHeader("Set-Cookie",e),t.json("Ok")}catch(e){return console.log(e.message),t.status(500).json({err:"Radās kļūme"})}},checkForLogin:async(e,t)=>{try{let r=await (0,d.I)(e,t);if(!r)return;let a=await s._.playlist.findMany({where:{userId:r.id},include:{songs:{select:{songId:!0}}}});t.json({...r,playlists:a})}catch(e){return console.log(e.message),t.status(500).json({err:"Radās kļūme"})}}}},8438:(e,t,r)=>{r.d(t,{_:()=>s});let s=new(require("@prisma/client")).PrismaClient},9983:(e,t,r)=>{r.d(t,{I:()=>i});var s=r(9344),a=r.n(s),n=r(8438);let i=async(e,t)=>{try{let{refresh_token:r}=e.cookies;if(!r)return t.status(400).json({err:"Unauthorized"}),null;let s=a().verify(r,String(process.env.REFRESH_TOKEN_SECRET));if(!s)return t.status(400).json({err:"Unauthorized"}),null;let i=await n._.user.findFirst({where:{id:Number(s)}});if(!i)return t.status(400).json({err:"Unauthorized"}),null;return i}catch(e){console.log(e)}}},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=8346);module.exports=r})();