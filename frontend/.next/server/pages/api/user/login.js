"use strict";(()=>{var e={};e.id=866,e.ids=[866],e.modules={9344:e=>{e.exports=require("jsonwebtoken")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},9602:(e,r,t)=>{t.r(r),t.d(r,{config:()=>d,default:()=>l,routeModule:()=>c});var s={};t.r(s),t.d(s,{default:()=>u});var a=t(1802),n=t(7153),i=t(6249),o=t(9255);function u(e,r){"POST"===e.method&&o.R.login(e,r)}let l=(0,i.l)(s,"default"),d=(0,i.l)(s,"config"),c=new a.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/user/login",pathname:"/api/user/login",bundlePath:"",filename:""},userland:s})},9255:(e,r,t)=>{t.d(r,{R:()=>c});var s=t(8438);let a=require("bcrypt");var n=t.n(a);let i=require("cookie");var o=t(9344),u=t.n(o);let l=e=>u().sign(e,String(process.env.REFRESH_TOKEN_SECRET));var d=t(9983);let c={register:async(e,r)=>{try{let{username:t,password:a}=e.body;if(!t||!a)return r.status(400).json({err:"Aizpildiet visus datus"});if(t.lengh<3)return r.status(400).json({err:"Lietotājvārdam jabut vismas 3 rakstzīmes garam"});if(a.lengh<3)return r.status(400).json({err:"Parolei jabut vismas 3 rakstzīmes garam"});if(await s._.user.findFirst({where:{username:t}}))return r.status(400).json({err:"Lietotājvārds jau aizņemts"});let o=await n().hash(a,10),u=await s._.user.create({data:{username:t,password:o}}),d=l(u.id),c=(0,i.serialize)("refresh_token",d,{httpOnly:!0,secure:!0,maxAge:604800,path:"/"});return r.setHeader("Set-Cookie",c),r.json(u)}catch(e){return console.log(e.message),r.status(500).json({err:"Radās kļūme"})}},login:async(e,r)=>{try{let{username:t,password:a}=e.body;if(!t||!a)return r.status(400).json({err:"Aizpildiet visus datus"});if(t.lengh<3)return r.status(400).json({err:"Lietotājvārdam jabut vismas 3 rakstzīmes garam"});if(a.lengh<3)return r.status(400).json({err:"Parolei jabut vismas 3 rakstzīmes garam"});let o=await s._.user.findFirst({where:{username:t}});if(!o)return r.status(404).json({err:"Lietotājs ar šādu lietotājvārdu netika atrasts"});n().compare(a,o.password,function(e,t){if(!t)return r.status(400).json({err:"Nepareiza parole"});{let e=l(o.id),t=(0,i.serialize)("refresh_token",e,{httpOnly:!0,secure:!0,maxAge:604800,path:"/"});return r.setHeader("Set-Cookie",t),r.json(o)}})}catch(e){return console.log(e.message),r.status(500).json({err:"Radās kļūme"})}},logout:async(e,r)=>{try{let e=(0,i.serialize)("refresh_token","",{httpOnly:!0,secure:!0,maxAge:604800,path:"/"});r.setHeader("Set-Cookie",e),r.json("Ok")}catch(e){return console.log(e.message),r.status(500).json({err:"Radās kļūme"})}},checkForLogin:async(e,r)=>{try{let t=await (0,d.I)(e,r);if(!t)return;let a=await s._.playlist.findMany({where:{userId:t.id},include:{songs:{select:{songId:!0}}}});r.json({...t,playlists:a})}catch(e){return console.log(e.message),r.status(500).json({err:"Radās kļūme"})}}}},8438:(e,r,t)=>{t.d(r,{_:()=>s});let s=new(require("@prisma/client")).PrismaClient},9983:(e,r,t)=>{t.d(r,{I:()=>i});var s=t(9344),a=t.n(s),n=t(8438);let i=async(e,r)=>{try{let{refresh_token:t}=e.cookies;if(!t)return r.status(400).json({err:"Unauthorized"}),null;let s=a().verify(t,String(process.env.REFRESH_TOKEN_SECRET));if(!s)return r.status(400).json({err:"Unauthorized"}),null;let i=await n._.user.findFirst({where:{id:Number(s)}});if(!i)return r.status(400).json({err:"Unauthorized"}),null;return i}catch(e){console.log(e)}}},7153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,r,t)=>{e.exports=t(145)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var t=r(r.s=9602);module.exports=t})();